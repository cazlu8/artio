
## Description
# ENGAGE API
back end for the engage app.

## Stack
```bash
   Node.JS - Is a JavaScript runtime built on V8 engine (https://nodejs.org/en/)
   Typescript - Is a typed superset of JavaScript that compiles to plain JavaScript (https://www.typescriptlang.org/)
   NestJS - A progressive architectural framework for node.js (https://nestjs.com/)
   Fastify - A HTTP Provider to Node.JS (https://www.fastify.io/)
   AWS logging - A AWS cloud service to use as API logger  
   Typeorm - ORM for full suport to Typescript (https://typeorm.io/)
   Swagger - API Development for documentation (https://swagger.io/)
              - you can access the engage-api documentation generated by swagger using the following URL:
                localhost:3000/swagger
```

## Prerequisites

```bash
- node lastest LTS version (12.x) of node installed on your machine
- postgres server version 11 installed on your machine - https://www.postgresql.org/
   - create a database called engage-api-dev (recommended)
- pgadmin postgres  (recommended)
  steps to configure the database connection
    - pick the ssl mode as Verify-CA
    - get the database credentails at LastPass into shared-development folder (engage-dev-database)
       - put all credential at their fields of connection chapter

    - find the cert assigned to your name at LastPass (engage-dev-database-yourname-cert)
    - find the key assigned to your name at LastPass(engage-dev-database-yourname-key)
    - find the ca shared-development (engage-api-server-ca)
    - put each one of above at their following fields at SSL chapter of pg admin server
```

## Style guide linter
```bash
 - the project uses the AIRBNB style guide with some custom rules (vide .eslint.js at root)
 - install the eslint plugin to VSCODE (https://marketplace.visualstudio.com/items?itemName=dbaeumer.vscode-eslint)
 - install the prettier plugin to VSCODe (https://github.com/prettier/prettier-vscode)
```


## Installing dependencies 
```bash
- get .env file (engage-api-env-file-dev) at LastPass, you will find it at shared-development folder
- put the content of this file at a file called .env at root of project
- run the following cmd:
  npm i
- check if after executed the cmd above, generated a folder called node_module at root of project
```

## Setup your local database

```bash
# generate migrations, typeorm will watch the changes made into all entities (is recommended to generate a migration by entity/change)
$npm run typeorm:migrate

# run migrations
$ npm run typeorm:run
```

## CI/CD

```bash
# pipeline 
    stages:  
      - test
         - the merge request must repect the rules/guide-line and formatting of eslint and prettier.
      - deploy staging
        - the deploy is done targeting the staging enviroment
      - deploy production (manual trigger, never run without authorization)
        - the deploy is done targeting the production enviroment
   
All merge requests must be reviews and approved by at least 1 teammate.
All merge request will be merged only after the pipeline run with success.
The environment variables are saved on the gitlab UI.
gitlab-ci.yml has the pipeline settings (the stages steps).
app.template.yaml has the configurations for the deploy on the app engine.  
```

## Project Organization (architecture/structure)
```bash        
├──  app.template.yaml <- this file contain the configuration of App Engine instance (hosting enviroment). 
├── .gitlab-ci.yml     <- this file contain the configuration of gitlab CI/CD. 
├── .env               <- this file is on LastPass account on Shared-Development folder as .env-development, you have to copy/paste in a file called .env in the root of project.
├── node_modules       <- packages of node/third part, only at development time (npm run install create this folder).
├── dist               <- the compiled javascript, only at development time (nest compiles typescript to javasctipt).
├── test               <- have the entity based folters with the e2e tests.
├── src                <- Source code for use in this project.
│   ├── migrations O(n)   <- folder containing the migrations in creation order generated by TypeORM or manual written (database structure versioning)
│   │   ├── [migration-name]  <- the raw (string) query or code using the query builder.
│   ├── modules O(n)      <- folder containing the modules, based on entity.
│   │   ├── [module-name]     <- modules structured on hexagonal architecture and feature/entity folder based
│   │   │   ├── [module-name].controller.ts  <- controller of the module (might not exists depending of the module). 
│   │   │   ├── [module-name].entity.ts      <- the class that represents the entity/table of the module (might not exists depending of the module).
│   │   │   ├── [module-name].module.ts      <- the module root, where is setup what is export from module or import into module (required in all modules).
│   │   │   ├── [module-name].service.ts     <- the layer that is responsbile for the business rules and logic, it orchestrate and uses the repositories.
│   │   │   ├── [module-name].repository.ts  <- the layer that is responsbile for the data access, it have direct access to the database operations, this file will exists only if is needed a custom repository (TyperORM already have a repository base which is extended of the respective entity on the service layer).
│   │   ├── index.ts          <- read all modules (folders) and get all roots of the modules (loader).
│   ├── shared            <- folder with the abstractions that can used on different modules of the project (DRY concept).
│   │   ├── config O(n)       <- have named-infra based folders which have config files.
│   │   ├── controllers O(n)  <- have controllers with some kind of abstractation.
│   │   ├── exceptions O(n)   <- have entity based folders which have custom exceptions.
│   │   ├── filters O(n)      <- have the filters (files) that are applied universal by type on the app (filter is a abstraction to handle errors and send a friendly/custom response to the client).
│   │   ├── guards O(n)       <- have the guards (files) that are applied on entire controllers or specific endpoints, guard is a middleware abstraction that is executed before the handler (controller layer) for authorization/security/rules and apply levels of use such as roles.
│   │   ├── interceptors O(n) <- have the interceptors (files) that are applied on controllers, interceptor is a middleware abstraction that is executed between the request/response and the handler/client and can change the behavior of the request or response.
│   │   ├── middlewares O(n)  <- have the regular middlewares (files) that can have code that can be executed between request and a handler, in this case is basically used for authentication, or any else kind of middleware that does not match with the another abstractions.
│   │   ├── modules O(n)      <- have loader modules (files), a root file that imports/exports a bundle of components/abstractions that are used in common in some part.
│   │   ├── services O(n)     <- have services (files), that can be used in different parts/modules.
│   ├── main.ts               <- bootstrap (init) the server  
│   ├── ormconfig.ts          <- setup the database configuration (ORM: TypeORM)
│   ├── app.module.ts         <- load all sub-modules (each child-folder of src is a module)
```

## Running the app

```bash
# development
$ npm run start

# watch mode
$ npm run start:dev

# production mode
$ npm run start:prod
```

## Test

```bash
# unit tests
$ npm run test

# e2e tests
$ npm run test:e2e

# test coverage
$ npm run test:cov
```
